# GitHub Actions å·¥ä½œæµé…ç½®æ–‡ä»¶

# å·¥ä½œæµåç§°ï¼Œæ˜¾ç¤ºåœ¨ GitHub Actions ä¸­ã€‚
name: openwrt-buildå›ºä»¶äº‘ç¼–è¯‘

on:
  workflow_dispatch:
    inputs:
      force-build:
        description: "æ— è®ºå¦‚ä½•æ„å»ºæ–°å›ºä»¶"
        required: false
        default: "false"
      ssh:
        description: "è¿æ¥åˆ°Actionsçš„SSH-ä¾‹å¦‚ä½ å¯ä»¥è‡ªå·±æ„å»ºå›ºä»¶"
        required: false
        default: "false"
      # è®¾ç½®å›ºä»¶é»˜è®¤åœ°å€
      ip:
        description: "å›ºä»¶é»˜è®¤åœ°å€ (ä¾‹å¦‚: 192.168.1.1)"
        required: true  # å¦‚æœä½ å¸Œæœ›è¿™æ˜¯å¿…å¡«é¡¹
        type: string
        default: "192.168.1.77"  # å¯é€‰ï¼Œé»˜è®¤ IP åœ°å€
# å–æ¶ˆæ³¨é‡Šä»¥ä¸‹å†…å®¹ä»¥å®šæœŸè¿è¡Œã€‚æ³¨æ„è¿™é‡Œçš„ cron è¡¨è¾¾å¼ä¸åŒ…å«ç§’ã€‚
#  schedule:
#    - cron: 0 */18 * * *

env:
  # REPO è¡¨ç¤ºä½ æƒ³è¦åœ¨æ­¤å·¥ä½œæµä¸­æ„å»ºçš„ OpenWrt ä»“åº“ã€‚
  # ä½ å¯ä»¥ä¿®æ”¹ REPO_NAME ä¸ºä½ æƒ³è¦çš„ä»»ä½•åç§°ï¼Œä½†è¯·ç¡®ä¿å®ƒä¸å…¶ä»–å·¥ä½œæµä¸­çš„åç§°ä¸åŒã€‚
  REPO_NAME: openwrt
  REPO_URL: https://github.com/openwrt/openwrt.git
  REPO_BRANCH: openwrt-24.10
  BUILD_DEPENDS: "libncurses-dev gawk flex quilt libssl-dev rsync \
    zlib1g-dev unzip time bc bison gcc-multilib g++-multilib \
    gettext texinfo u-boot-tools cpio dosfstools kmod \
    libelf-dev libssl-dev pkg-config device-tree-compiler"
  # CONFIG_FILE æ˜¯ä½ è‡ªå·±çš„ç¼–è¯‘é…ç½®æ–‡ä»¶çš„åç§°ï¼Œä½ åº”è¯¥å°†è¿™äº›æ–‡ä»¶ä¸Šä¼ åˆ°å·¥ä½œæµä»“åº“çš„æ ¹ç›®å½•ã€‚
  CONFIG_FILE: example.config
  # CUSTOM_SCRIPT_1 æ˜¯ä½ åœ¨æ›´æ–°å’Œå®‰è£… feeds ä¹‹å‰è¦æ‰§è¡Œçš„é¢å¤– Bash è„šæœ¬çš„åç§°ã€‚
  # CUSTOM_SCRIPT_2 æ˜¯ä½ åœ¨æ›´æ–°å’Œå®‰è£… feeds ä¹‹åè¦æ‰§è¡Œçš„é¢å¤– Bash è„šæœ¬çš„åç§°ã€‚
  # å¦‚æœä½ éœ€è¦é€šè¿‡è¿™ä¸¤ä¸ªè„šæœ¬æ¥ä¿®æ”¹å›ºä»¶çš„åˆå§‹è®¾ç½®ï¼Œè¯·å°†è„šæœ¬ä¸Šä¼ åˆ°å·¥ä½œæµä»“åº“çš„æ ¹ç›®å½•ã€‚
  CUSTOM_SCRIPT_1: example-custom-script-1.sh
  CUSTOM_SCRIPT_2: example-custom-script-2.sh
  # STORE_PRODUCTS ç¡®å®šæ˜¯å¦å°†æ‰€æœ‰ç¼–è¯‘äº§ç‰©ä¸Šä¼ åˆ°å·¥ä½œæµåˆ¶å“ã€‚
  # ä¸ä»…ä»…æ˜¯å›ºä»¶ï¼Œè¿˜åŒ…æ‹¬æ‰€æœ‰ç¼–è¯‘ä½†æœªå›ºåŒ–åˆ°å›ºä»¶ä¸­çš„åŒ…ã€‚
  STORE_PRODUCTS: false
  # STORE_FIRMWARE ç¡®å®šæ˜¯å¦å°†å›ºä»¶ä¸Šä¼ åˆ°å·¥ä½œæµåˆ¶å“ã€‚
  STORE_FIRMWARE: true
  # ä»¥ä¸‹é€‰é¡¹ç¡®å®šå›ºä»¶éœ€è¦ä¼ è¾“çš„ä½ç½®ã€‚
  COWTRANSFER_FIRMWARE: false
  WETRANSFER_FIRMWARE: false
  RELEASE_FIRMWARE: true
  # æ›´æ”¹ä¸ºä½ çš„æ—¶åŒºã€‚
  TIME_ZONE: Asia/Shanghai

jobs:
  check:
    name: æ£€æŸ¥æºä»£ç æ›´æ–°
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-hash.outputs.cache-hit }}

    steps:
      - name: è·å–æäº¤å“ˆå¸Œ
        id: get-hash
        run: |
          git clone --depth 1 --branch $REPO_BRANCH --single-branch $REPO_URL ./
          echo "commit-hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: æ¯”è¾ƒæäº¤å“ˆå¸Œ
        id: cache-hash
        uses: actions/cache@main
        with:
          path: .${{ env.REPO_NAME }}-${{ env.REPO_BRANCH }}-commit-hash
          key: HEAD-${{ steps.get-hash.outputs.commit-hash }}

      - name: ä¿å­˜æ–°çš„æäº¤å“ˆå¸Œ
        if: steps.cache-hash.outputs.cache-hit != 'true'
        run: |
          echo ${{ steps.get-hash.outputs.commit-hash }} | 
            tee .$REPO_NAME-$REPO_BRANCH-commit-hash

  build:
    name: æ„å»ºå›ºä»¶
    runs-on: ubuntu-latest
    needs: check
    permissions:
      contents: write
    if: needs.check.outputs.cache-hit != 'true' || github.event.inputs.force-build == 'true'

    steps:
      - name: é‡Šæ”¾ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false

      - name: åˆå¹¶ç£ç›˜ç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 1024
          temp-reserve-mb: 100
          root-reserve-mb: 1024

      - name: åˆå§‹åŒ–ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # æ¸…ç†æ—§çš„æºåˆ—è¡¨
          sudo rm -rf /etc/apt/sources.list.d/*

          # æ·»åŠ å®˜æ–¹æºå’Œå¿…è¦çš„ç¬¬ä¸‰æ–¹æº
          echo "deb http://archive.ubuntu.com/ubuntu $(lsb_release -sc) main universe multiverse" | sudo tee /etc/apt/sources.list
          echo "deb http://archive.ubuntu.com/ubuntu $(lsb_release -sc)-updates main universe multiverse" | sudo tee -a /etc/apt/sources.list
          sudo -E apt update -y
          sudo -E apt upgrade -y
          sudo -E apt-get -y install $BUILD_DEPENDS
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get -y clean
          sudo -E apt-get install -y clang
          sudo timedatectl set-timezone $TIME_ZONE

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@main

      - name: å…‹éš†æºä»£ç 
        run: |
          df -hT $PWD
          git clone --depth 1 --branch $REPO_BRANCH --single-branch $REPO_URL openwrt
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          COMMIT_AUTHOR=$(git show -s --date=short --format="ä½œè€…: %an")
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          COMMIT_AUTHOR=$(git show -s --date=short --format="ä½œè€…: %an")
          echo "COMMIT_AUTHOR=$COMMIT_AUTHOR" >> $GITHUB_ENV
          COMMIT_DATE=$(git show -s --date=short --format="æ—¶é—´: %ci")
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV
          COMMIT_MESSAGE=$(git show -s --date=short --format="å†…å®¹: %s")
          echo "COMMIT_MESSAGE=$COMMIT_MESSAGE" >> $GITHUB_ENV
          COMMIT_HASH=$(git show -s --date=short --format="hash: %H")
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          cd ..

      - name: è¿è¡Œè‡ªå®šä¹‰è„šæœ¬1
        run: |
          chmod +x $GITHUB_WORKSPACE/$CUSTOM_SCRIPT_1
          cd openwrt/
          $GITHUB_WORKSPACE/$CUSTOM_SCRIPT_1

      - name: æ›´æ–° feeds
        run: cd openwrt/ && ./scripts/feeds update -a

      - name: å®‰è£… feeds
        run: cd openwrt/ && ./scripts/feeds install -a

      - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
        run: |
          [ -e files ] && mv $GITHUB_WORKSPACE/files/ openwrt/files/
          [ -e $CONFIG_FILE ] && mv $GITHUB_WORKSPACE/$CONFIG_FILE openwrt/.config
          cd openwrt/
          make defconfig > /dev/null 2>&1
          SOURCE_REPO="$(echo $REPO_URL | awk -F '/' '{print $(NF)}')"
          echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
          DEVICE_TARGET=$(cat .config | grep CONFIG_TARGET_BOARD | awk -F '"' '{print $2}')
          echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
          DEVICE_SUBTARGET=$(cat .config | grep CONFIG_TARGET_SUBTARGET | awk -F '"' '{print $2}')
          echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV
          sed -i "s/192.168.1.1/$github.event.inputs.ip/g" package/base-files/files/bin/config_generate
      - name: è¿è¡Œè‡ªå®šä¹‰è„šæœ¬2
        run: |
          chmod +x $GITHUB_WORKSPACE/$CUSTOM_SCRIPT_2
          cd openwrt/
          $GITHUB_WORKSPACE/$CUSTOM_SCRIPT_2

      - name: SSH è¿æ¥åˆ° Actions
        uses: P3TERX/ssh2actions@main
        if: github.event.inputs.ssh == 'true' || contains(github.event.action, 'ssh')
        env:
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

      - name: ä¸‹è½½è½¯ä»¶åŒ…
        id: download-packages
        run: |
          cd openwrt/
          make defconfig
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd openwrt/
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
          [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
          echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ
        if: (!cancelled())
        run: df -hT

      - name: ä¸Šä¼ æ‰€æœ‰ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@main
        if: steps.compile.outputs.status == 'success' && env.STORE_PRODUCTS == 'true'
        with:
          name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/bin/

      - name: ç»„ç»‡å›ºä»¶ç›¸å…³æ–‡ä»¶
        id: organize-files
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages/
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ å›ºä»¶ç›®å½•
        uses: actions/upload-artifact@main
        if: steps.organize-files.outputs.status == 'success' && env.STORE_FIRMWARE == 'true' && !cancelled()
        with:
          name: ${{ env.SOURCE_REPO }}-firmware-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}

      - name: ä¸Šä¼ å›ºä»¶åˆ° Cowtransfer
        id: cowtransfer
        if: steps.organize-files.outputs.status == 'success' && env.COWTRANSFER_FIRMWARE == 'true' && !cancelled()
        run: |
          curl -fsSL git.io/file-transfer | sh
          ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
          echo "::notice file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
          echo "url=$(cat cowtransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ å›ºä»¶åˆ° WeTransfer
        id: wetransfer
        if: steps.organize-files.outputs.status == 'success' && env.WETRANSFER_FIRMWARE == 'true' && !cancelled()
        run: |
          curl -fsSL git.io/file-transfer | sh
          ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
          echo "::notice file=wetransfer.com::$(cat wetransfer.log | grep https)"
          echo "url=$(cat wetransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ å›ºä»¶åˆ°Release
        if: steps.organize-files.outputs.status == 'success' && !cancelled()
        uses: ncipollo/release-action@v1
        with:
          name: R${{ env.DATE }} for ${{ env.DEVICE_TARGET }}
          allowUpdates: true
          tag: ${{ env.DEVICE_TARGET }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: ${{ env.FIRMWARE }}/*
          body: |
            **è¿™æ˜¯ä¸º ${{ env.DEVICE_TARGET }} ç¼–è¯‘çš„OpenWrtå›ºä»¶**
            ### ğŸ“’ å›ºä»¶ä¿¡æ¯
            - ğŸ’» å¹³å°æ¶æ„: ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
            - âš½ å›ºä»¶æºç : ${{ env.REPO_URL }}
            - ğŸ’ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
            - ğŸš€ å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL }}
            - ğŸŒ é»˜è®¤åœ°å€: ${{ github.event.inputs.ip }}
            ### ğŸ§Š å›ºä»¶ç‰ˆæœ¬
            - å›ºä»¶ç¼–è¯‘å‰æœ€åä¸€æ¬¡â¦[ä¸»æºç ](${{ env.REPO_URL }})æ›´æ–°è®°å½•
            - ${{ env.COMMIT_AUTHOR }}
            - ${{ env.COMMIT_DATE }}
            - ${{ env.COMMIT_MESSAGE }}
            - ${{ env.COMMIT_HASH }}

  clean:
    name: æ¸…ç†æ—§èµ„äº§
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write

    steps:
      - name: åˆ é™¤å·¥ä½œæµè¿è¡Œ
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 1

      - name: ç§»é™¤æ—§ç‰ˆæœ¬
        uses: dev-drprasad/delete-older-releases@master
        if: env.RELEASE_FIRMWARE == 'true' && !cancelled()
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

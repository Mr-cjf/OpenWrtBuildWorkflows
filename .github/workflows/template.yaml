# GitHub Actions å·¥ä½œæµé…ç½®æ–‡ä»¶
# æ­¤å·¥ä½œæµç”¨äºè‡ªåŠ¨ç¼–è¯‘ OpenWrt å›ºä»¶ï¼ŒåŸºäº example.config é…ç½®æ–‡ä»¶
# example.config åŒ…å«äº†å®Œæ•´çš„ OpenWrt é…ç½®é€‰é¡¹ï¼Œå®šä¹‰äº†å›ºä»¶çš„åŠŸèƒ½ç‰¹æ€§
# å¦‚ç›®æ ‡æ¶æ„ã€å†…æ ¸ç‰ˆæœ¬ã€é¢„è£…è½¯ä»¶åŒ…ã€ç½‘ç»œæœåŠ¡å’Œç¡¬ä»¶é©±åŠ¨ç­‰

# å·¥ä½œæµåç§°ï¼Œæ˜¾ç¤ºåœ¨ GitHub Actions ä¸­ã€‚
name: openwrt-buildå›ºä»¶äº‘ç¼–è¯‘

on:
  workflow_dispatch:
    inputs:
      force-build:
        description: "æ— è®ºå¦‚ä½•æ„å»ºæ–°å›ºä»¶"
        required: true
        default: "true"
      ssh:
        description: "è¿æ¥åˆ°Actionsçš„SSH-ä¾‹å¦‚ä½ å¯ä»¥è‡ªå·±æ„å»ºå›ºä»¶"
        required: false
        default: "false"
      # è®¾ç½®å›ºä»¶é»˜è®¤åœ°å€
      ip:
        description: "å›ºä»¶é»˜è®¤åœ°å€ (ä¾‹å¦‚: 192.168.1.1)"
        required: true  # å¦‚æœä½ å¸Œæœ›è¿™æ˜¯å¿…å¡«é¡¹
        type: string
        default: "192.168.1.77"  # å¯é€‰ï¼Œé»˜è®¤ IP åœ°å€
# å–æ¶ˆæ³¨é‡Šä»¥ä¸‹å†…å®¹ä»¥å®šæœŸè¿è¡Œã€‚æ³¨æ„è¿™é‡Œçš„ cron è¡¨è¾¾å¼ä¸åŒ…å«ç§’ã€‚
#  schedule:
#    - cron: 0 */18 * * *

env:
  # REPO è¡¨ç¤ºä½ æƒ³è¦åœ¨æ­¤å·¥ä½œæµä¸­æ„å»ºçš„ OpenWrt ä»“åº“ã€‚
  # ä½ å¯ä»¥ä¿®æ”¹ REPO_NAME ä¸ºä½ æƒ³è¦çš„ä»»ä½•åç§°ï¼Œä½†è¯·ç¡®ä¿å®ƒä¸å…¶ä»–å·¥ä½œæµä¸­çš„åç§°ä¸åŒã€‚
  REPO_NAME: openwrt
  REPO_URL: https://github.com/openwrt/openwrt.git
  REPO_BRANCH: v24.10.0  # é»˜è®¤ç‰ˆæœ¬ï¼Œå°†è¢«è‡ªåŠ¨è·å–çš„æœ€æ–°ç‰ˆæœ¬è¦†ç›–
  BUILD_DEPENDS: "libncurses-dev gawk flex quilt libssl-dev rsync \
    zlib1g-dev unzip time bc bison gcc-multilib g++-multilib \
    gettext texinfo u-boot-tools cpio dosfstools kmod \
    libelf-dev libssl-dev pkg-config device-tree-compiler protobuf-c-compiler libprotobuf-c-dev ccache"
  # CONFIG_FILE æ˜¯ä½ è‡ªå·±çš„ç¼–è¯‘é…ç½®æ–‡ä»¶çš„åç§°ï¼Œä½ åº”è¯¥å°†è¿™äº›æ–‡ä»¶ä¸Šä¼ åˆ°å·¥ä½œæµä»“åº“çš„æ ¹ç›®å½•ã€‚
  CONFIG_FILE: example.config
  # CUSTOM_SCRIPT_1 æ˜¯ä½ åœ¨æ›´æ–°å’Œå®‰è£… feeds ä¹‹å‰è¦æ‰§è¡Œçš„é¢å¤– Bash è„šæœ¬çš„åç§°ã€‚
  # CUSTOM_SCRIPT_2 æ˜¯ä½ åœ¨æ›´æ–°å’Œå®‰è£… feeds ä¹‹åè¦æ‰§è¡Œçš„é¢å¤– Bash è„šæœ¬çš„åç§°ã€‚
  # å¦‚æœä½ éœ€è¦é€šè¿‡è¿™ä¸¤ä¸ªè„šæœ¬æ¥ä¿®æ”¹å›ºä»¶çš„åˆå§‹è®¾ç½®ï¼Œè¯·å°†è„šæœ¬ä¸Šä¼ åˆ°å·¥ä½œæµä»“åº“çš„æ ¹ç›®å½•ã€‚
  CUSTOM_SCRIPT_1: example-custom-script-1.sh
  CUSTOM_SCRIPT_2: example-custom-script-2.sh
  # STORE_PRODUCTS ç¡®å®šæ˜¯å¦å°†æ‰€æœ‰ç¼–è¯‘äº§ç‰©ä¸Šä¼ åˆ°å·¥ä½œæµåˆ¶å“ã€‚
  # ä¸ä»…ä»…æ˜¯å›ºä»¶ï¼Œè¿˜åŒ…æ‹¬æ‰€æœ‰ç¼–è¯‘ä½†æœªå›ºåŒ–åˆ°å›ºä»¶ä¸­çš„åŒ…ã€‚
  STORE_PRODUCTS: false
  # STORE_FIRMWARE ç¡®å®šæ˜¯å¦å°†å›ºä»¶ä¸Šä¼ åˆ°å·¥ä½œæµåˆ¶å“ã€‚
  STORE_FIRMWARE: true
  # ä»¥ä¸‹é€‰é¡¹ç¡®å®šå›ºä»¶éœ€è¦ä¼ è¾“çš„ä½ç½®ã€‚
  COWTRANSFER_FIRMWARE: false
  WETRANSFER_FIRMWARE: false
  RELEASE_FIRMWARE: true
  # æ›´æ”¹ä¸ºä½ çš„æ—¶åŒºã€‚
  TIME_ZONE: Asia/Shanghai

jobs:
  check:
    name: æ£€æŸ¥æºä»£ç æ›´æ–°
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-hash.outputs.cache-hit }}
      latest-version: ${{ steps.get-latest-version.outputs.latest-version }}

    steps:
      - name: è·å–æœ€æ–°ç‰ˆæœ¬
        id: get-latest-version
        run: |
          # è·å– OpenWrt ä»“åº“çš„æ‰€æœ‰å¯ç”¨åˆ†æ”¯å’Œæ ‡ç­¾
          echo "ğŸ” æ­£åœ¨è·å– OpenWrt ä»“åº“çš„å¯ç”¨ç‰ˆæœ¬..."
          
          # å…ˆè·å–æ‰€æœ‰æ ‡ç­¾
          ALL_TAGS=$(curl -s "https://api.github.com/repos/openwrt/openwrt/tags" | \
            grep '"name"' | \
            grep -oP 'v\d+\.\d+\.\d+' | \
            sort -V -r)
          
          # éªŒè¯æ ‡ç­¾æ˜¯å¦çœŸçš„å­˜åœ¨äºè¿œç¨‹ä»“åº“
          LATEST_VERSION=""
          for tag in $ALL_TAGS; do
            echo "  æ£€æŸ¥æ ‡ç­¾: $tag"
            if git ls-remote --exit-code --tags $REPO_URL refs/tags/$tag > /dev/null 2>&1; then
              LATEST_VERSION="$tag"
              echo "  âœ… æ‰¾åˆ°æœ‰æ•ˆæ ‡ç­¾: $LATEST_VERSION"
              break
            fi
          done
          
          # å¦‚æœè·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬
          if [ -z "$LATEST_VERSION" ]; then
            LATEST_VERSION="$REPO_BRANCH"
            echo "âš ï¸ æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: $LATEST_VERSION"
          else
            echo "âœ… æ£€æµ‹åˆ°æœ€æ–°ç‰ˆæœ¬: $LATEST_VERSION"
          fi
          
          echo "latest-version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: è·å–æäº¤å“ˆå¸Œ
        id: get-hash
        run: |
          BRANCH_TO_USE="${{ steps.get-latest-version.outputs.latest-version }}"
          git clone --depth 1 --branch $BRANCH_TO_USE --single-branch $REPO_URL ./
          echo "commit-hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: æ¯”è¾ƒæäº¤å“ˆå¸Œ
        id: cache-hash
        uses: actions/cache@main
        with:
          path: .${{ env.REPO_NAME }}-${{ steps.get-latest-version.outputs.latest-version }}-commit-hash
          key: HEAD-${{ steps.get-hash.outputs.commit-hash }}

      - name: ä¿å­˜æ–°çš„æäº¤å“ˆå¸Œ
        if: steps.cache-hash.outputs.cache-hit != 'true'
        run: |
          echo ${{ steps.get-hash.outputs.commit-hash }} | 
            tee .$REPO_NAME-${{ steps.get-latest-version.outputs.latest-version }}-commit-hash

  build:
    name: æ„å»ºå›ºä»¶
    runs-on: ubuntu-latest
    needs: check
    permissions:
      contents: write
    if: needs.check.outputs.cache-hit != 'true' || github.event.inputs.force-build == 'true'

    steps:
      - name: é‡Šæ”¾ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false

      - name: åˆå¹¶ç£ç›˜ç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 1024
          temp-reserve-mb: 100
          root-reserve-mb: 1024

      - name: åˆå§‹åŒ–ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # æ¸…ç†æ—§çš„æºåˆ—è¡¨
          sudo rm -rf /etc/apt/sources.list.d/*

          # æ·»åŠ å®˜æ–¹æºå’Œå¿…è¦çš„ç¬¬ä¸‰æ–¹æº
          echo "deb https://archive.ubuntu.com/ubuntu $(lsb_release -sc) main universe multiverse" | sudo tee /etc/apt/sources.list
          echo "deb https://archive.ubuntu.com/ubuntu $(lsb_release -sc)-updates main universe multiverse" | sudo tee -a /etc/apt/sources.list
          sudo -E apt update -y
          sudo -E apt upgrade -y
          sudo -E apt-get -y install $BUILD_DEPENDS
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get -y clean
          sudo -E apt-get install -y clang
          sudo timedatectl set-timezone $TIME_ZONE


      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@main

      - name: å…‹éš†æºä»£ç 
        run: |
          df -hT $PWD
          BRANCH_TO_USE="${{ needs.check.outputs.latest-version }}"
          echo "ğŸš€ ä½¿ç”¨ç‰ˆæœ¬: $BRANCH_TO_USE"
          git clone --depth 1 --branch $BRANCH_TO_USE --single-branch $REPO_URL openwrt
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV

      - name: ç¼“å­˜ç¼–è¯‘äº§ç‰©
        uses: actions/cache@v4
        with:
          path: |
            openwrt/dl
            openwrt/staging_dir/host
            openwrt/staging_dir/toolchain
            openwrt/.ccache
          key: ${{ runner.os }}-openwrt-${{ env.REPO_NAME }}-${{ needs.check.outputs.latest-version }}-${{ hashFiles('example.config') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-${{ env.REPO_NAME }}-${{ needs.check.outputs.latest-version }}-

      - name: æ³¨å…¥æäº¤ä¿¡æ¯
        run: |
          cd openwrt
          echo "COMMIT_AUTHOR=$(git show -s --date=short --format="ä½œè€…: %an")" >> $GITHUB_ENV
          echo "COMMIT_DATE=$(git show -s --date=short --format="æ—¶é—´: %ci")" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$(git show -s --date=short --format="å†…å®¹: %s")" >> $GITHUB_ENV
          echo "COMMIT_HASH=$(git show -s --date=short --format="hash: %H")" >> $GITHUB_ENV
          echo "VERSION_INFO=${{ needs.check.outputs.latest-version }}" >> $GITHUB_ENV


      - name: è¿è¡Œè‡ªå®šä¹‰è„šæœ¬1
        run: |
          chmod +x $GITHUB_WORKSPACE/$CUSTOM_SCRIPT_1
          cd openwrt/
          $GITHUB_WORKSPACE/$CUSTOM_SCRIPT_1


      - name: æ›´æ–° feeds
        run: |
          cd openwrt/
          echo "ğŸš€ æ­£åœ¨æ›´æ–°è½¯ä»¶æº..."
          
          # å°è¯•å¤šæ¬¡æ›´æ–° feedsï¼Œå› ä¸ºç½‘ç»œå¯èƒ½ä¸ç¨³å®š
          attempt=1
          max_attempts=3
          
          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ”„ ç¬¬ $attempt æ¬¡å°è¯•æ›´æ–°è½¯ä»¶æº..."
            
            # é¦–å…ˆå¤‡ä»½ feeds é…ç½®
            cp feeds.conf.default feeds.conf
            
            # å¦‚æœä½¿ç”¨çš„æ˜¯ä¸­å›½å¤§é™†ç”¨æˆ·ï¼Œæ›¿æ¢ä¸ºé•œåƒæº
            if [ "$TIME_ZONE" = "Asia/Shanghai" ]; then
              echo "ğŸŒ æ£€æµ‹åˆ°ä¸­å›½æ—¶åŒºï¼Œä½¿ç”¨é•œåƒæº..."
              sed -i 's|https://git.openwrt.org/feed/packages.git|https://mirrors.ustc.edu.cn/openwrt-feeds/packages.git|g' feeds.conf
              sed -i 's|https://git.openwrt.org/project/luci.git|https://mirrors.ustc.edu.cn/openwrt-luci.git|g' feeds.conf
              sed -i 's|https://git.openwrt.org/feed/routing.git|https://mirrors.ustc.edu.cn/openwrt-feeds/routing.git|g' feeds.conf
              sed -i 's|https://git.openwrt.org/feed/telephony.git|https://mirrors.ustc.edu.cn/openwrt-feeds/telephony.git|g' feeds.conf
            fi
            
            # æ›´æ–°è½¯ä»¶æº
            if ./scripts/feeds update -a; then
              echo "âœ… è½¯ä»¶æºæ›´æ–°æˆåŠŸ"
              
              # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•è½¯ä»¶æºæ›´æ–°æˆåŠŸ
              if [ -d "feeds/packages" ] || [ -d "feeds/luci" ] || [ -d "feeds/routing" ] || [ -d "feeds/telephony" ]; then
                echo "âœ… è‡³å°‘æœ‰ä¸€ä¸ªè½¯ä»¶æºæ›´æ–°æˆåŠŸ"
                break
              else
                echo "âš ï¸ è­¦å‘Š: æ²¡æœ‰ä»»ä½•è½¯ä»¶æºç›®å½•è¢«åˆ›å»ºï¼Œä½†å‘½ä»¤è¿”å›æˆåŠŸ"
              fi
            else
              echo "âŒ ç¬¬ $attempt æ¬¡å°è¯•å¤±è´¥"
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "â³ ç­‰å¾… 30 ç§’åé‡è¯•..."
              sleep 30
            fi
            
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "ğŸ’¥ æ‰€æœ‰å°è¯•éƒ½å¤±è´¥äº†ï¼Œæ˜¾ç¤ºé”™è¯¯æ—¥å¿—:"
            find logs/ -name "*.txt" -exec echo "=== {} ===" \; -exec cat {} \; 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°é”™è¯¯æ—¥å¿—"
            exit 1
          fi
          
          echo "âœ… è½¯ä»¶æºæ›´æ–°å®Œæˆ"

      - name: å®‰è£… feeds
        run: |
          cd openwrt/
          echo "ğŸš€ æ­£åœ¨å®‰è£…è½¯ä»¶åŒ…..."
          if ! ./scripts/feeds install -a; then
            echo "âŒ å®‰è£…è½¯ä»¶åŒ…å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯æ—¥å¿—:"
            find logs/ -name "*.txt" -exec echo "=== {} ===" \; -exec cat {} \;
            echo "--- æ£€æŸ¥ feeds ç›®å½•ç»“æ„ ---"
            ls -la feeds/
            echo "--- æ£€æŸ¥ .config æ–‡ä»¶å†…å®¹ ---"
            cat .config | head -20
            exit 1
          fi
          echo "âœ… è½¯ä»¶åŒ…å®‰è£…å®Œæˆ"
          echo "--- å·²å®‰è£…çš„è½¯ä»¶æºç›®å½•åˆ—è¡¨ ---"
          ls -d feeds/* 2>/dev/null || echo "âš ï¸ æœªå‘ç° feeds ç›®å½•"
          echo "----------------------------"

      - name: åŠ è½½è‡ªå®šä¹‰é…ç½®å¹¶ç”Ÿæˆé…ç½®æ‘˜è¦
        # æ­¤æ­¥éª¤å¤„ç† example.config é…ç½®æ–‡ä»¶ä¸­çš„å„é¡¹è®¾ç½®
        # å¹¶åŠ¨æ€ç”Ÿæˆé…ç½®æ‘˜è¦ä»¥ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        run: |
          echo "================================================="
          echo "ğŸ” è°ƒè¯•ä¿¡æ¯: å¼€å§‹åŠ è½½è‡ªå®šä¹‰é…ç½®"
          echo "ğŸ“‚ å½“å‰ç›®å½•: $PWD"
          echo "ğŸ“„ é…ç½®æ–‡ä»¶: $CONFIG_FILE"
          echo "ğŸŒ æºç åœ°å€: $REPO_URL"
          echo "================================================="

          # ç¡®ä¿æºç ç›®å½•å­˜åœ¨
          if [ ! -d "openwrt" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° openwrt æºç ç›®å½•ï¼Œè¯·æ£€æŸ¥å…‹éš†æ­¥éª¤ï¼"
            ls -la
            exit 1
          fi

          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          mkdir -p openwrt/files
          
          # å¤åˆ¶è‡ªå®šä¹‰ files ç›®å½•
          if [ -d "files" ]; then
            echo "ğŸšš æ­£åœ¨å¤åˆ¶è‡ªå®šä¹‰ files ç›®å½•å†…å®¹..."
            cp -rv files/* openwrt/files/
            echo "âœ… files ç›®å½•å¤åˆ¶å®Œæˆ"
          else
            echo "â„¹ï¸ ä¿¡æ¯: æœªå‘ç°è‡ªå®šä¹‰ files ç›®å½•ï¼Œè·³è¿‡å¤åˆ¶"
          fi
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          if [ -f "$CONFIG_FILE" ]; then
            echo "ğŸšš æ­£åœ¨åº”ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶: $CONFIG_FILE"
            cp -v "$CONFIG_FILE" openwrt/.config
            echo "âœ… é…ç½®æ–‡ä»¶å·²å¤åˆ¶åˆ° openwrt/.config"
          else
            echo "âš ï¸ è­¦å‘Š: è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ $CONFIG_FILE ä¸å­˜åœ¨ï¼å°†ä½¿ç”¨é»˜è®¤é…ç½®ã€‚"
          fi
          
          cd openwrt/
          # å¼€å¯ ccache æé€Ÿ
          echo "ğŸš€ é…ç½® ccache..."
          echo "CONFIG_CCACHE=y" >> .config
          
          # è¿è¡Œ make defconfig
          echo "ğŸš€ æ­£åœ¨è¿è¡Œ make defconfig (è¿™å¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´)..."
          if make defconfig; then
            echo "âœ… make defconfig æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ é”™è¯¯: make defconfig æ‰§è¡Œå¤±è´¥ï¼"
            exit 1
          fi
          
          # æ£€æŸ¥ .config æ˜¯å¦ç”ŸæˆæˆåŠŸå¹¶æ‰“å°å…³é”®é¡¹
          if [ -f ".config" ]; then
            echo "âœ… .config æ–‡ä»¶å·²å°±ç»ª"
            echo "--- .config å…³é”®é…ç½®ç‰‡æ®µ ---"
            grep -E "CONFIG_TARGET_BOARD|CONFIG_TARGET_SUBTARGET|CONFIG_TARGET_ARCH_PACKAGES" .config || true
            echo "----------------------------"
          else
            echo "âŒ é”™è¯¯: æ ¸å¿ƒé…ç½®æ–‡ä»¶ .config ä¸¢å¤±ï¼"
            exit 1
          fi
          
          SOURCE_REPO="$(echo "$REPO_URL" | awk -F '/' '{print $(NF)}')"
          echo "SOURCE_REPO=$SOURCE_REPO" >> "$GITHUB_ENV"
          
          # æå–è®¾å¤‡ä¿¡æ¯
          DEVICE_TARGET=$(grep CONFIG_TARGET_BOARD .config | awk -F '"' '{print $2}' || echo "unknown")
          DEVICE_SUBTARGET=$(grep CONFIG_TARGET_SUBTARGET .config | awk -F '"' '{print $2}' || echo "unknown")
          echo "ğŸ“Œ è¯†åˆ«åˆ°ç›®æ ‡å¹³å°: $DEVICE_TARGET / $DEVICE_SUBTARGET"
          echo "DEVICE_TARGET=$DEVICE_TARGET" >> "$GITHUB_ENV"
          echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> "$GITHUB_ENV"
          
          # ä¿®æ”¹é»˜è®¤IPåœ°å€ - æ£€æŸ¥å¤šä¸ªå¯èƒ½çš„è·¯å¾„
          CONFIG_GENERATE_PATH=""
          for path in "package/base-files/files/bin/config_generate" "package/base-files/root/bin/config_generate"; do
            if [ -f "$path" ]; then
              CONFIG_GENERATE_PATH="$path"
              break
            fi
          done
          
          if [ -n "$CONFIG_GENERATE_PATH" ]; then
            echo "ğŸ“ æ­£åœ¨ä¿®æ”¹é»˜è®¤ IP åœ°å€..."
            echo "ğŸ“ ç›®æ ‡æ–‡ä»¶: $CONFIG_GENERATE_PATH"
            sed -i "s/192.168.1.1/${{ github.event.inputs.ip }}/g" "$CONFIG_GENERATE_PATH"
            if grep -q "${{ github.event.inputs.ip }}" "$CONFIG_GENERATE_PATH"; then
              echo "âœ… IP åœ°å€å·²æˆåŠŸä¿®æ”¹ä¸º: ${{ github.event.inputs.ip }}"
            else
              echo "âŒ é”™è¯¯: IP åœ°å€ä¿®æ”¹éªŒè¯å¤±è´¥ï¼"
              exit 1
            fi
          else
            echo "âš ï¸ è­¦å‘Š: æœªèƒ½åœ¨ä»»ä½•å·²çŸ¥è·¯å¾„ä¸‹æ‰¾åˆ° config_generate æ–‡ä»¶ï¼Œè·³è¿‡ IP ä¿®æ”¹"
          fi
          echo "================================================="
          echo "ğŸ‰ åŠ è½½è‡ªå®šä¹‰é…ç½®æ­¥éª¤å®Œæˆ"
          echo "================================================="
          
          # ç”Ÿæˆé…ç½®æ‘˜è¦æ–‡ä»¶
          echo "## é…ç½®æ‘˜è¦" > ../config_summary.md
          echo "- ç›®æ ‡æ¶æ„: $(grep '^CONFIG_TARGET_' .config | grep '=y' | head -5 | tr '\n' ',' | sed 's/,$//')" >> ../config_summary.md
          echo "- å†…æ ¸ç‰ˆæœ¬: $(grep '^CONFIG_LINUX_' .config | grep '=y' | tr '\n' ',' | sed 's/,$//')" >> ../config_summary.md
          echo "- ç½‘ç»œæœåŠ¡: $(grep -E '^CONFIG_DEFAULT_(dnsmasq|firewall4|dropbear|ppp|odhcpd)' .config | grep '=y' | sed 's/CONFIG_DEFAULT_//' | sed 's/=y//' | tr '\n' ',' | sed 's/,$//')" >> ../config_summary.md
          echo "- ç½‘ç»œé©±åŠ¨: $(grep -E '^CONFIG_DEFAULT_kmod-(e1000|igb|r8169|tg3|bnx2|forcedeth)' .config | grep '=y' | sed 's/CONFIG_DEFAULT_//' | sed 's/=y//' | tr '\n' ',' | sed 's/,$//')" >> ../config_summary.md

      - name: è¿è¡Œè‡ªå®šä¹‰è„šæœ¬2
        run: |
          chmod +x $GITHUB_WORKSPACE/$CUSTOM_SCRIPT_2
          cd openwrt/
          $GITHUB_WORKSPACE/$CUSTOM_SCRIPT_2


      - name: SSH è¿æ¥åˆ° Actions
        uses: P3TERX/ssh2actions@main
        if: github.event.inputs.ssh == 'true' || contains(github.event.action, 'ssh')
        env:
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

      - name: ä¸‹è½½è½¯ä»¶åŒ…
        id: download-packages
        run: |
          cd openwrt/
          make defconfig
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;


      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd openwrt/
          # æ£€æŸ¥ ccache æ˜¯å¦å®‰è£…
          if ! command -v ccache &> /dev/null; then
            echo "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ° ccache å‘½ä»¤ï¼Œå°è¯•åŠ¨æ€å®‰è£…..."
            sudo apt-get update && sudo apt-get install -y ccache
          fi
          
          # è®¾ç½® ccache ç›®å½•å¹¶è®¾å®š 5GB ä¸Šé™
          export CCACHE_DIR=$PWD/.ccache
          ccache -M 5G
          ccache -z
          echo -e "ğŸš€ å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨çº¿ç¨‹æ•°: $(($(nproc) + 1))"
          make -j$(($(nproc) + 1)) || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          ccache -s
          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
          [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
          echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV


      - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ
        if: (!cancelled())
        run: df -hT

      - name: ä¸Šä¼ æ‰€æœ‰ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@main
        if: steps.compile.outputs.status == 'success' && env.STORE_PRODUCTS == 'true'
        with:
          name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/bin/

      - name: ç»„ç»‡å›ºä»¶ç›¸å…³æ–‡ä»¶
        id: organize-files
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages/
          
          # é‡å‘½åå›ºä»¶æ–‡ä»¶
          for file in openwrt-*; do
            if [ -f "$file" ]; then
              # é€»è¾‘ï¼šå°†å¼€å¤´çš„ "openwrt-" æ›¿æ¢ä¸º "openwrt_ç‰ˆæœ¬å·-"
              # å…¶ä½™éƒ¨åˆ†ï¼ˆå¦‚ x86-64-generic-ext4-combined-efi.img.gzï¼‰å®Œå…¨ä¿ç•™
              new_name="openwrt_${{ env.VERSION_INFO }}-${file#openwrt-}"
              mv "$file" "$new_name"
              echo "ğŸšš é‡å‘½å: $file -> $new_name"
            fi
          done
          
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: å‡†å¤‡åŠ¨æ€é…ç½®è¯´æ˜
        run: |
          cd openwrt/
          # ç”Ÿæˆå®Œæ•´çš„å‘å¸ƒè¯´æ˜ï¼ŒåŒ…å«æ ‡å‡†ä¿¡æ¯å’ŒåŠ¨æ€é…ç½®è¯¦æƒ…
          {
          echo "**è¿™æ˜¯ä¸º ${{ env.DEVICE_TARGET }} ç¼–è¯‘çš„OpenWrtå›ºä»¶**"
          echo "### ğŸ“’ å›ºä»¶ä¿¡æ¯"
          echo "- ğŸ’» å¹³å°æ¶æ„: ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}"
          echo "- âš½ å›ºä»¶æºç : ${{ env.REPO_URL }}"
          echo "- ğŸ’ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}"
          echo "- ğŸš€ å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL }}"
          echo "- ğŸŒ é»˜è®¤åœ°å€: ${{ github.event.inputs.ip }}"
          echo "### ğŸ§Š å›ºä»¶ç‰ˆæœ¬"
          echo "- å›ºä»¶ç¼–è¯‘å‰æœ€åä¸€æ¬¡â¦[ä¸»æºç ](${{ env.REPO_URL }})æ›´æ–°è®°å½•"
          echo "- ${{ env.COMMIT_AUTHOR }}"
          echo "- ${{ env.COMMIT_DATE }}"
          echo "- ${{ env.COMMIT_MESSAGE }}"
          echo "- ${{ env.COMMIT_HASH }}"
          echo ""
          echo "### ğŸ”§ å®é™…é…ç½®è¯¦æƒ…"
          
          # æå–ç›®æ ‡æ¶æ„ä¿¡æ¯
          TARGETS=$(grep '^CONFIG_TARGET_' .config | grep '=y' | head -5 | tr '\n' ', ' | sed 's/, $//')
          echo "- ç›®æ ‡æ¶æ„: $TARGETS"
          
          # æå–å†…æ ¸ç‰ˆæœ¬
          KERNEL=$(grep '^CONFIG_LINUX_' .config | grep '=y' | tr '\n' ', ' | sed 's/, $//')
          echo "- å†…æ ¸ç‰ˆæœ¬: $KERNEL"
          
          # æå–ç³»ç»ŸåŸºç¡€åŒ…
          BASE_SYSTEM=$(grep -E '^CONFIG_DEFAULT_(base-files|libc|libgcc|musl|procd|ubus|uci|uclient-fetch|urandom-seed|urngd|fstools|mtd|netifd|swconfig|uboot-envtools|ucron|uhttpd)' .config | grep '=y' | sed 's/CONFIG_DEFAULT_//' | sed 's/=y//' | tr '\n' ', ' | sed 's/, $//')
          echo "- åŸºç¡€ç³»ç»Ÿ: $BASE_SYSTEM"
          
          # æå–ç½‘ç»œæœåŠ¡
          NETWORK=$(grep -E '^CONFIG_DEFAULT_(dnsmasq|firewall4|dropbear|ppp|ppp-mod-pppoe|odhcpd|odhcp6c|firewall|resolveip|kmod-ipt-offload|ca-bundle)' .config | grep '=y' | sed 's/CONFIG_DEFAULT_//' | sed 's/=y//' | tr '\n' ', ' | sed 's/, $//')
          echo "- ç½‘ç»œæœåŠ¡: $NETWORK"
          
          # æå–ç½‘ç»œé©±åŠ¨
          DRIVERS=$(grep -E '^CONFIG_DEFAULT_kmod-(e1000|igb|r8169|tg3|bnx2|forcedeth|ath|mt76|rt|atl1c|ixgbe|igc|kmod-usb-net|kmod-usb-net-asix|kmod-usb-net-rtl8152)' .config | grep '=y' | sed 's/CONFIG_DEFAULT_//' | sed 's/=y//' | tr '\n' ', ' | sed 's/, $//')
          echo "- ç½‘ç»œé©±åŠ¨: $DRIVERS"
          
          # æå–æ— çº¿ç½‘ç»œç›¸å…³
          WIFI=$(grep -E '^CONFIG_DEFAULT_(hostapd|wpad-mini|wpad|kmod-cfg80211|kmod-mac80211|kmod-ath9k|kmod-ath10k|kmod-rt2800|kmod-rt73-usb)' .config | grep '=y' | sed 's/CONFIG_DEFAULT_//' | sed 's/=y//' | tr '\n' ', ' | sed 's/, $//')
          echo "- æ— çº¿ç½‘ç»œ: $WIFI"
          
          # æå–å­˜å‚¨å’Œæ–‡ä»¶ç³»ç»Ÿ
          STORAGE=$(grep -E '^CONFIG_DEFAULT_(e2fsprogs|mkf2fs|partx-utils|f2fs-tools|kmod-fs-vfat|kmod-fs-ext4|kmod-fs-ntfs|kmod-usb-storage|kmod-usb-storage-extras|kmod-usb3|kmod-usb2)' .config | grep '=y' | sed 's/CONFIG_DEFAULT_//' | sed 's/=y//' | tr '\n' ', ' | sed 's/, $//')
          echo "- å­˜å‚¨æ”¯æŒ: $STORAGE"
          
          # æå–å®‰å…¨åŠŸèƒ½
          SECURITY=$(grep -E '^CONFIG_DEFAULT_(firewall4|nftables|kmod-ipt-nat|kmod-nf-nathelper-ct|kmod-tun|kmod-udptunnel6|openvpn|openvpn-easy-rsa)' .config | grep '=y' | sed 's/CONFIG_DEFAULT_//' | sed 's/=y//' | tr '\n' ', ' | sed 's/, $//')
          echo "- å®‰å…¨åŠŸèƒ½: $SECURITY"
          
          # æå–å®¹å™¨å’Œè™šæ‹ŸåŒ–æ”¯æŒ
          CONTAINER=$(grep -E '^CONFIG_DEFAULT_(docker|dockerd|containerd|runc|lxc|lxc-attach|kmod-virtio|kmod-virtio-blk|kmod-virtio-console|kmod-virtio-net)' .config | grep '=y' | sed 's/CONFIG_DEFAULT_//' | sed 's/=y//' | tr '\n' ', ' | sed 's/, $//')
          [ -n "$CONTAINER" ] && echo "- å®¹å™¨æ”¯æŒ: $CONTAINER" || echo "- å®¹å™¨æ”¯æŒ: æ— "
          
          # æå–å¼€å‘å·¥å…·
          DEV_TOOLS=$(grep -E '^CONFIG_DEFAULT_(gcc|gdb|strace|tcpdump|iperf3|screen|tmux|vim-full|nano)' .config | grep '=y' | sed 's/CONFIG_DEFAULT_//' | sed 's/=y//' | tr '\n' ', ' | sed 's/, $//')
          [ -n "$DEV_TOOLS" ] && echo "- å¼€å‘å·¥å…·: $DEV_TOOLS" || echo "- å¼€å‘å·¥å…·: æ— "
          
          # æå–LuCI Webç•Œé¢ç»„ä»¶
          LUCI=$(grep -E '^CONFIG_DEFAULT_(luci|luci-base|luci-mod-admin-full|luci-theme-bootstrap|luci-theme-openwrt-2020|luci-app-firewall|luci-app-opkg|luci-proto-ipv6|luci-proto-ppp)' .config | grep '=y' | sed 's/CONFIG_DEFAULT_//' | sed 's/=y//' | tr '\n' ', ' | sed 's/, $//')
          [ -n "$LUCI" ] && echo "- LuCIç•Œé¢: $LUCI" || echo "- LuCIç•Œé¢: æ— "
          
          # æå–ç³»ç»Ÿæ€§èƒ½å’Œç›‘æ§
          MONITORING=$(grep -E '^CONFIG_DEFAULT_(htop|iftop|vnstat|vnstati|iotop|dstat|kmod-ledtrig-heartbeat|kmod-ledtrig-gpio)' .config | grep '=y' | sed 's/CONFIG_DEFAULT_//' | sed 's/=y//' | tr '\n' ', ' | sed 's/, $//')
          [ -n "$MONITORING" ] && echo "- æ€§èƒ½ç›‘æ§: $MONITORING" || echo "- æ€§èƒ½ç›‘æ§: æ— "
          
          # ç»Ÿè®¡æ€»æ•°
          TOTAL_PKGS=$(grep '^CONFIG_DEFAULT_' .config | grep '=y' | wc -l)
          TOTAL_DRIVERS=$(grep '^CONFIG_DEFAULT_kmod-' .config | grep '=y' | wc -l)
          echo ""
          echo "### ğŸ“Š é…ç½®ç»Ÿè®¡"
          echo "- æ€»è®¡å¯ç”¨è½¯ä»¶åŒ…: $TOTAL_PKGS ä¸ª"
          echo "- æ€»è®¡å¯ç”¨é©±åŠ¨: $TOTAL_DRIVERS ä¸ª"
          } > ../dynamic_config_notes.md


      - name: ä¸Šä¼ å›ºä»¶ç›®å½•
        uses: actions/upload-artifact@main
        if: steps.organize-files.outputs.status == 'success' && env.STORE_FIRMWARE == 'true' && !cancelled()
        with:
          name: ${{ env.SOURCE_REPO }}-firmware-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}

      - name: ä¸Šä¼ å›ºä»¶åˆ° Cowtransfer
        id: cowtransfer
        if: steps.organize-files.outputs.status == 'success' && env.COWTRANSFER_FIRMWARE == 'true' && !cancelled()
        run: |
          curl -fsSL git.io/file-transfer | sh
          ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
          echo "::notice file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
          echo "url=$(cat cowtransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_OUTPUT


      - name: ä¸Šä¼ å›ºä»¶åˆ° WeTransfer
        id: wetransfer
        if: steps.organize-files.outputs.status == 'success' && env.WETRANSFER_FIRMWARE == 'true' && !cancelled()
        run: |
          curl -fsSL git.io/file-transfer | sh
          ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
          echo "::notice file=wetransfer.com::$(cat wetransfer.log | grep https)"
          echo "url=$(cat wetransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_OUTPUT


      - name: ä¸Šä¼ å›ºä»¶åˆ°Release
        if: steps.organize-files.outputs.status == 'success' && !cancelled()
        uses: ncipollo/release-action@v1
        with:
          name: openwrt_${{ env.VERSION_INFO }}_${{ env.DEVICE_TARGET }}_${{ env.DATE }}
          allowUpdates: true
          tag: openwrt_${{ env.VERSION_INFO }}_${{ env.DEVICE_TARGET }}${{ env.FILE_DATE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: ${{ env.FIRMWARE }}/*
          body: |
            **è¿™æ˜¯ä¸º ${{ env.DEVICE_TARGET }} ç¼–è¯‘çš„ OpenWrt å›ºä»¶**
            ### ğŸ“’ å›ºä»¶ä¿¡æ¯
            - ğŸ’» å¹³å°æ¶æ„: ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
            - âš½ å›ºä»¶æºç : ${{ env.REPO_URL }}
            - ğŸ’ æºç ç‰ˆæœ¬: ${{ env.VERSION_INFO }}
            - ğŸŒ é»˜è®¤åœ°å€: ${{ github.event.inputs.ip }}
            ### ğŸ§Š æºç æ›´æ–°è®°å½•
            - ${{ env.COMMIT_AUTHOR }}
            - ${{ env.COMMIT_DATE }}
            - ${{ env.COMMIT_MESSAGE }}
            - ${{ env.COMMIT_HASH }}
          bodyFile: dynamic_config_notes.md


  clean:
    name: æ¸…ç†æ—§èµ„äº§
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write

    steps:
      - name: åˆ é™¤å·¥ä½œæµè¿è¡Œ
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 1

      - name: ç§»é™¤æ—§ç‰ˆæœ¬
        uses: dev-drprasad/delete-older-releases@master
        if: env.RELEASE_FIRMWARE == 'true' && !cancelled()
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
